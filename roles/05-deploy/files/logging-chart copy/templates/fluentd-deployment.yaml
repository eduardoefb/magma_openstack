apiVersion: apps/v1
kind: Deployment
metadata:
  name: fluentd
  labels:
    app: fluentd
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fluentd
  strategy:
    type: Recreate
  template:
    metadata:
      annotations: {}
      creationTimestamp: null
      labels:
        app: fluentd
    spec:
      imagePullSecrets:
      - name: {{ .Values.fluentd.image.imagePullSecret }}

      containers:
      - image: {{ .Values.fluentd.image.repository }}:{{ .Values.fluentd.image.tag }}
        imagePullPolicy: ""
        name: fluentd
        env:
          - name: OUTPUT_HOST
            value: "elasticsearch"
          - name: OUTPUT_PORT
            value: "9200"
          - name: OUTPUT_SCHEME
            value: "http"
          - name: OUTPUT_SSL_VERSION
            value: "TLSv1"
          - name: OUTPUT_BUFFER_CHUNK_LIMIT
            value: "2M"
          - name: OUTPUT_BUFFER_QUEUE_LIMIT
            value: "8"        
        ports:
        - containerPort: 24224
        - containerPort: 24224
          protocol: UDP
        - containerPort: 24225
        - containerPort: 24225
          protocol: UDP
        resources: {}        
        volumeMounts:
        - mountPath: /etc/fluent/config.d
          name: config-volume-fluentd
        - mountPath: /var/log/fluentd-buffers
          name: buffer
        - mountPath: /certs
          name: certs
          readOnly: true
      restartPolicy: Always
      serviceAccountName: ""
      volumes:
      - configMap:
          defaultMode: 511
          name: orc8r-fluentd-forward-configs
        name: config-volume-fluentd
      - emptyDir: {}
        name: buffer
      - name: certs
        secret:
          defaultMode: 420
          secretName: fluentd-certs